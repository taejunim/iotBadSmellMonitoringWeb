<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iotBadSmellMonitoring.statistic.service.impl.StatisticMapper">

    <!-- 통계 -->
    <select id="statisticListSelect" parameterType="statisticVO" resultType="egovMap">
        SELECT SMELL_VALUE
             , F_GET_CODE_NAME('SMT',A.SMELL_VALUE) SMELL_VALUE_NAME
        <choose>

            <when test="searchGbn.equals('day')">
             , COUNT(SMELL_VALUE)               CNT
             , DATE_FORMAT(REG_DT, '%Y-%m-%d') REG_DT
        FROM TB_SMELL_REGISTER A LEFT JOIN (
                SELECT   USER_ID
                       , USER_REGION
                FROM tb_user ) B ON A.REG_ID = B.USER_ID
       WHERE 1=1
                <if test="region != null and !region.equals('')" >
         AND B.USER_REGION = #{region}
                </if>
         AND DATE_FORMAT(REG_DT, '%Y-%m-%d') BETWEEN #{searchStart} AND #{searchEnd}

       GROUP BY SMELL_VALUE, DATE_FORMAT(REG_DT, '%Y-%m-%d')
       ORDER BY REG_DT, SMELL_VALUE
            </when>
            <when test="searchGbn.equals('month')">
             , COUNT(SMELL_VALUE)            CNT
             , DATE_FORMAT(REG_DT, '%Y-%m') REG_DT

        FROM TB_SMELL_REGISTER A LEFT JOIN (
                SELECT   USER_ID
                , USER_REGION
                FROM tb_user ) B ON A.REG_ID = B.USER_ID
       WHERE 1=1
                <if test="region != null and !region.equals('')" >
         AND B.USER_REGION = #{region}
                </if>
         AND DATE_FORMAT(REG_DT, '%Y-%m') BETWEEN #{searchStart} AND #{searchEnd}
       GROUP BY SMELL_VALUE, DATE_FORMAT(REG_DT, '%Y-%m')
       ORDER BY REG_DT, SMELL_VALUE
            </when>
            <when test="searchGbn.equals('year')">
            , COUNT(SMELL_VALUE)         CNT
            , DATE_FORMAT(REG_DT, '%Y') REG_DT

                FROM TB_SMELL_REGISTER A LEFT JOIN (
                SELECT USER_ID,
                USER_REGION
                FROM tb_user ) B ON A.REG_ID = B.USER_ID
       WHERE 1=1
                <if test="region != null and !region.equals('')" >
         AND B.USER_REGION = #{region}
                </if>
         AND DATE_FORMAT(REG_DT, '%Y') BETWEEN #{searchStart} AND #{searchEnd}
     GROUP BY SMELL_VALUE, DATE_FORMAT(REG_DT, '%Y')
     ORDER BY REG_DT, SMELL_TYPE
            </when>
            <otherwise>
             , COUNT(SMELL_VALUE)                            CNT
             , F_GET_CODE_NAME('REN',A.SMELL_REGISTER_TIME) REG_DT
     FROM TB_SMELL_REGISTER A LEFT JOIN (
                SELECT   USER_ID
                , USER_REGION
                FROM tb_user ) B ON A.REG_ID = B.USER_ID
    WHERE 1=1
                <if test="region != null and !region.equals('')" >
      AND B.USER_REGION = #{region}
                </if>
      AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') = DATE_FORMAT(curdate(), '%Y-%m-%d')
      AND A.SMELL_REGISTER_TIME IN(
                #{searchStart}
                <if test='searchStart lt "002" and searchEnd gte "002"' >
                    ,'002'
                </if>
                <if test='searchStart lt "003" and searchEnd gte "003"' >
                    ,'003'
                </if>
                <if test='searchStart lt "004" and searchEnd gte "004"' >
                    ,'004'
                </if>
                )
      GROUP BY SMELL_VALUE, A.SMELL_REGISTER_TIME
      ORDER BY A.SMELL_REGISTER_TIME, SMELL_VALUE
            </otherwise>
        </choose>
    </select>
</mapper>